name: Run Test

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  run-golden-record:
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.draft == false)

    env:
      CC: gcc
      CXX: g++
      FC: gfortran
      MPI_HOME: /usr

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Set up Python 3
        run: |
          python -m pip install --upgrade pip
          pip install numpy

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: git cmake make ninja-build gcc g++ gfortran jq libopenblas-dev liblapack-dev libsuitesparse-dev libfftw3-dev libgsl-dev libhdf5-dev libnetcdf-dev libnetcdff-dev python3-dev libevent-dev libnuma-dev libhwloc-dev libnl-3-dev libnl-route-3-dev libltdl-dev openmpi-bin openmpi-common libopenmpi-dev
          version: 1.0
          execute_install_scripts: true

      - name: Ensure BLAS and MPI are properly configured
        run: |
          # Fallback installation to ensure pkg-config files are present
          sudo apt-get update
          sudo apt-get install -y --reinstall libopenblas-dev pkg-config
          sudo apt-get install -y --reinstall openmpi-bin openmpi-common libopenmpi-dev
          
          # Verify BLAS can be found
          pkg-config --exists openblas && echo "OpenBLAS pkg-config found" || echo "Warning: OpenBLAS pkg-config not found"
          
          # Verify MPI can be found
          pkg-config --exists ompi && echo "OpenMPI pkg-config found" || echo "Warning: OpenMPI pkg-config not found"
          which mpifort && echo "mpifort found at: $(which mpifort)" || echo "Warning: mpifort not found"
          
          # Set environment variables to help CMake
          echo "BLA_VENDOR=OpenBLAS" >> $GITHUB_ENV
          echo "MPI_HOME=/usr" >> $GITHUB_ENV

      - name: Set up Python 3
        run: |
          python -m pip install --upgrade pip
          pip install numpy

      - name: Clone test data
        id: data
        env:
          GITLAB_ACCESS_TOKEN: ${{ secrets.GITLAB_ACCESS_TOKEN }}
        run: |
          set -e

          TEMP_DIR=$(mktemp -d)
          cd $TEMP_DIR 

          if [ ! -d "data" ]; then
            echo "Fetching test data..."
            git clone https://oauth2:${GITLAB_ACCESS_TOKEN}@gitlab.tugraz.at/plasma/data.git
          fi

          cd data
          echo "data_dir=$(pwd)" >> $GITHUB_OUTPUT
          
      - name: Install libneo python required by NEO-2 python
        run: pip install git+https://github.com/itpplasma/libneo.git

      - name: Install NEO-2 python
        run: |
          cd python
          pip install -e .


      - name: Build NEO-2 (current version)
        id: build
        run: |
          make
          echo "neo2_par=$(pwd)/build/NEO-2-PAR/neo_2_par.x" >> $GITHUB_OUTPUT
          echo "neo2_ql=$(pwd)/build/NEO-2-QL/neo_2_ql.x" >> $GITHUB_OUTPUT

      - name: Build NEO-2 (reference version - latest stable release)
        id: build_reference
        run: |
          # Build reference version in temp directory
          REFERENCE_DIR=$(mktemp -d)
          cd $REFERENCE_DIR

          git clone https://github.com/itpplasma/NEO-2.git .

          # Get latest stable release tag from GitHub API
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/itpplasma/NEO-2/releases/latest | jq -r '.tag_name')
          if [ -z "$LATEST_RELEASE" ] || [ "$LATEST_RELEASE" == "null" ]; then
            echo "Error: Failed to fetch the latest release tag from GitHub API." >&2
            exit 1
          fi
          echo "Building reference version from latest stable release: $LATEST_RELEASE"
          git checkout $LATEST_RELEASE

          # Use same tag for libneo (synchronized versioning)
          echo "Using synchronized libneo tag: $LATEST_RELEASE"
          make LIBNEO_GIT_TAG=$LATEST_RELEASE

          echo "neo2_ql_stable=$(pwd)/build/NEO-2-QL/neo_2_ql.x" >> $GITHUB_OUTPUT
          echo "neo2_par_stable=$(pwd)/build/NEO-2-PAR/neo_2_par.x" >> $GITHUB_OUTPUT

      - name: Run golden record test against stable version (rough check)
        env:
          CURRENT_NEO2_PAR: ${{ steps.build.outputs.neo2_par }}
          REFERENCE_NEO2_PAR: ${{ steps.build_reference.outputs.neo2_par_stable }}
          CURRENT_NEO2_QL: ${{ steps.build.outputs.neo2_ql }}
          REFERENCE_NEO2_QL: ${{ steps.build_reference.outputs.neo2_ql_stable }}
        id: run_test_stable
        continue-on-error: true
        run: |
          set -e

          NEO2_BRANCH=${{ github.head_ref || github.ref_name }}
          TEST_DIR=TESTS/NEO-2/golden_record/

          cd ${{ steps.data.outputs.data_dir }}

          git fetch origin
          if git ls-remote --exit-code --heads origin "$NEO2_BRANCH" > /dev/null; then
            echo "Checking out $NEO2_BRANCH"
            git checkout "$NEO2_BRANCH"
          else
            echo "Branch '$NEO2_BRANCH' not found in data. Falling back to main"
            git checkout main
          fi

          git pull
          source activate.sh
          git config lfs.fetchinclude "$TEST_DIR"
          git config lfs.fetchexclude ""
          git lfs pull
          git lfs checkout "$TEST_DIR"
          cd "$TEST_DIR"
          echo "test_dir=$(pwd)" >> $GITHUB_OUTPUT

          export TOL=1e-14
          export LEGACY_TOL=1e-10
          export MAGNETICS_TOL=1e-12
          make lorentz

          export TOL=1e-10
          export LEGACY_TOL=1e-8
          make ql

      - name: Upload test (against stable) output on failure
        if: steps.run_test_stable.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: golden-test-stable-output
          path: |
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/current/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/current/out
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/reference/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/reference/out
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/current/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/current/out
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/reference/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/reference/out

      - name: Build NEO-2 (reference version - main branch)
        if: github.event_name == 'pull_request'
        id: build_reference_main
        run: |
          # Build reference version from main branch for PR comparison
          REFERENCE_MAIN_DIR=$(mktemp -d)
          cd $REFERENCE_MAIN_DIR

          git clone https://github.com/itpplasma/NEO-2.git .

          echo "Building reference version from main branch"
          git checkout main

          make

          echo "neo2_ql_main=$(pwd)/build/NEO-2-QL/neo_2_ql.x" >> $GITHUB_OUTPUT

      - name: Run golden record test against main version (exact check)
        if: github.event_name == 'pull_request'
        env:
          CURRENT_NEO2_QL: ${{ steps.build.outputs.neo2_ql }}
          REFERENCE_NEO2_QL: ${{ steps.build_reference_main.outputs.neo2_ql_main }}
        id: run_test_main
        continue-on-error: true
        run: |
          set -e
          cd ${{ steps.run_test_stable.outputs.test_dir }}

          export TOL=1e-14
          export LEGACY_TOL=1e-10
          export MAGNETICS_TOL=1e-12
          make lorentz

          export TOL=1e-15
          export LEGACY_TOL=1e-8
          make ql

      - name: Upload test (against main) output on failure
        if: steps.run_test_main.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: golden-test-main-output
          path: |
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/current/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/current/out
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/reference/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/lorentz/reference/out
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/current/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/current/out
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/reference/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/ql/reference/out

      - name: Run QL performance test
        if: github.event_name == 'pull_request'
        env:
          CURRENT_NEO2_QL: ${{ steps.build.outputs.neo2_ql }}
          REFERENCE_NEO2_QL: ${{ steps.build_reference_main.outputs.neo2_ql_main }}
        id: run_performance_test
        continue-on-error: true
        run: |
          set -e
          cd ${{ steps.run_test_stable.outputs.test_dir }}

          export TOL=1e-15
          make performance_ql

      - name: Upload performance test output on failure
        if: steps.run_performance_test.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-output
          path: |
            ${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/current/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/current/out
            ${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/current/timing.txt
            ${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/reference/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/reference/out
            ${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/reference/timing.txt
            ${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/performance_report.txt

      - name: Run (slow) par golden record test on pull request
        if: github.event_name == 'pull_request'
        env:
          CURRENT_NEO2_PAR: ${{ steps.build.outputs.neo2_par }}
        id: run_par_test
        continue-on-error: true
        run: |
          set -e
          cd ${{ steps.run_test_stable.outputs.test_dir }}

          export TOL=1e-15
          export LEGACY_TOL=2e-8
          make par

      - name: Upload par test output on failure
        if: steps.run_par_test.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: golden-test-par-output
          path: |
            ${{ steps.run_test_stable.outputs.test_dir }}/par/current/summary.h5
            ${{ steps.run_test_stable.outputs.test_dir }}/par/current/out

      - name: Report performance comparison
        if: always()
        run: |
          if [ -f "${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/performance_report.txt" ]; then
            echo "## Performance Test Results" >> $GITHUB_STEP_SUMMARY
            cat "${{ steps.run_test_stable.outputs.test_dir }}/performance_ql/performance_report.txt" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail the job on test failure
        if: steps.run_test_stable.outcome == 'failure' || steps.run_test_main.outcome == 'failure' || steps.run_par_test.outcome == 'failure' || steps.run_performance_test.outcome == 'failure'
        run: exit 1
